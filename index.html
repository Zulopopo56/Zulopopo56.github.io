<!DOCTYPE html>
<html>
<head>
  <title>P2P Чат на PeerJS</title>
  <style>
    body { font-family: Arial; max-width: 600px; margin: 0 auto; padding: 20px; }
    #chat { height: 300px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
    #message { width: 70%; padding: 8px; }
    #connection-status { 
      padding: 5px; 
      border-radius: 3px;
      display: inline-block;
      margin-left: 10px;
    }
    .disconnected { background: #ffcccc; color: #cc0000; }
    .connected { background: #ccffcc; color: #006600; }
    #remote-id { margin-right: 10px; }
  </style>
</head>
<body>
  <h1>P2P Чат (PeerJS)</h1>
  <div id="chat"></div>
  <input type="text" id="message" placeholder="Ваше сообщение" disabled>
  <button onclick="sendMessage()" disabled>Отправить</button>
  <hr>
  <div>
    <p>Ваш ID: <span id="your-id">...</span></p>
    <input type="text" id="remote-id" placeholder="ID собеседника">
    <button onclick="connectToPeer()">Подключиться</button>
    <span id="connection-status" class="disconnected">Не подключено</span>
  </div>

  <!-- Подключаем PeerJS -->
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script>
    let peer;
    let activeConnection;
    let isConnected = false;

    // Обновляем статус подключения
    function updateConnectionStatus() {
      const statusElement = document.getElementById('connection-status');
      if (isConnected) {
        statusElement.textContent = "Подключено";
        statusElement.className = "connected";
        document.getElementById('message').disabled = false;
        document.querySelector('button[onclick="sendMessage()"]').disabled = false;
      } else {
        statusElement.textContent = "Не подключено";
        statusElement.className = "disconnected";
        document.getElementById('message').disabled = true;
        document.querySelector('button[onclick="sendMessage()"]').disabled = true;
      }
    }

    // 1. Инициализация PeerJS
    function initPeer() {
      peer = new Peer({
        host: '0.peerjs.com',
        port: 443,
        secure: true,
        config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
      });

      // 2. Получаем свой ID
      peer.on('open', (id) => {
        document.getElementById('your-id').textContent = id;
        appendMessage('Система', 'Готов к подключению. Ваш ID: ' + id);
      });

      // Обработка ошибок
      peer.on('error', (err) => {
        appendMessage('Система', 'Ошибка: ' + err.message);
        isConnected = false;
        updateConnectionStatus();
      });

      // 3. Обработка входящих подключений
      peer.on('connection', (conn) => {
        activeConnection = conn;
        isConnected = true;
        updateConnectionStatus();
        appendMessage('Система', 'Кто-то подключился к вам!');
        
        conn.on('data', (data) => {
          appendMessage('Собеседник', data);
        });

        conn.on('close', () => {
          appendMessage('Система', 'Соединение закрыто');
          isConnected = false;
          updateConnectionStatus();
        });

        conn.on('error', (err) => {
          appendMessage('Система', 'Ошибка соединения: ' + err.message);
          isConnected = false;
          updateConnectionStatus();
        });
      });
    }

    // 4. Подключение к другому участнику
    function connectToPeer() {
      const remoteId = document.getElementById('remote-id').value;
      if (!remoteId) {
        appendMessage('Система', 'Введите ID собеседника');
        return;
      }

      appendMessage('Система', 'Попытка подключения к ' + remoteId + '...');
      activeConnection = peer.connect(remoteId);
      
      activeConnection.on('open', () => {
        isConnected = true;
        updateConnectionStatus();
        appendMessage('Система', 'Соединение установлено! Теперь можно общаться.');
      });
      
      activeConnection.on('data', (data) => {
        appendMessage('Собеседник', data);
      });

      activeConnection.on('close', () => {
        appendMessage('Система', 'Соединение закрыто');
        isConnected = false;
        updateConnectionStatus();
      });

      activeConnection.on('error', (err) => {
        appendMessage('Система', 'Ошибка подключения: ' + err.message);
        isConnected = false;
        updateConnectionStatus();
      });
    }

    // 5. Отправка сообщений
    function sendMessage() {
      const message = document.getElementById('message').value;
      if (!activeConnection || !message) return;
      
      activeConnection.send(message);
      appendMessage('Вы', message);
      document.getElementById('message').value = '';
    }

    // 6. Вывод сообщений в чат
    function appendMessage(sender, text) {
      const chat = document.getElementById('chat');
      const messageElement = document.createElement('div');
      messageElement.innerHTML = `<strong>${sender}:</strong> ${text}`;
      chat.appendChild(messageElement);
      chat.scrollTop = chat.scrollHeight;
    }

    // Запускаем при загрузке страницы
    initPeer();
    updateConnectionStatus();
  </script>
</body>
</html>