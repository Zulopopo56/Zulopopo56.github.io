<!DOCTYPE html>
<html>
<head>
  <title>P2P Чат на PeerJS</title>
  <style>
    body { font-family: Arial; max-width: 600px; margin: 0 auto; padding: 20px; }
    #chat { height: 300px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; }
    #message { width: 70%; padding: 8px; }
  </style>
</head>
<body>
  <h1>P2P Чат (PeerJS)</h1>
  <div id="chat"></div>
  <input type="text" id="message" placeholder="Ваше сообщение">
  <button onclick="sendMessage()">Отправить</button>
  <hr>
  <div>
    <p>Ваш ID: <span id="your-id">...</span></p>
    <input type="text" id="remote-id" placeholder="ID собеседника">
    <button onclick="connectToPeer()">Подключиться</button>
  </div>

  <!-- Подключаем PeerJS -->
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script>
    let peer;
    let activeConnection;

    // 1. Инициализация PeerJS
    function initPeer() {
      peer = new Peer({
        host: '0.peerjs.com', // Бесплатный публичный сервер
        port: 443,
        secure: true,
        config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
      });

      // 2. Получаем свой ID
      peer.on('open', (id) => {
        document.getElementById('your-id').textContent = id;
      });

      // 3. Обработка входящих подключений
      peer.on('connection', (conn) => {
        activeConnection = conn;
        appendMessage('Система', 'Кто-то подключился к вам!');
        
        conn.on('data', (data) => {
          appendMessage('Собеседник', data);
        });
      });
    }

    // 4. Подключение к другому участнику
    function connectToPeer() {
      const remoteId = document.getElementById('remote-id').value;
      activeConnection = peer.connect(remoteId);
      
      activeConnection.on('open', () => {
        appendMessage('Система', 'Соединение установлено!');
      });
      
      activeConnection.on('data', (data) => {
        appendMessage('Собеседник', data);
      });
    }

    // 5. Отправка сообщений
    function sendMessage() {
      const message = document.getElementById('message').value;
      if (!activeConnection || !message) return;
      
      activeConnection.send(message);
      appendMessage('Вы', message);
      document.getElementById('message').value = '';
    }

    // 6. Вывод сообщений в чат
    function appendMessage(sender, text) {
      const chat = document.getElementById('chat');
      const messageElement = document.createElement('div');
      messageElement.innerHTML = `<strong>${sender}:</strong> ${text}`;
      chat.appendChild(messageElement);
      chat.scrollTop = chat.scrollHeight;
    }

    // Запускаем при загрузке страницы
    initPeer();
  </script>
</body>
</html>